<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Jogo da Cobrinha - Bug Corrigido</title>
<style>
/* --- Estilos principais --- */
body {
  margin:0; font-family:Arial; background:linear-gradient(180deg,#071422 0%,#051718 100%);
  color:#e6f4ea; height:100vh; display:flex; align-items:center; justify-content:center;
}
#container { display:flex; flex-direction:column; align-items:center; gap:12px; position:relative; }
#hud { display:flex; gap:20px; align-items:center; font-weight:700; z-index:2; }
canvas#game {
  width:800px; height:600px; image-rendering:pixelated; border-radius:10px;
  box-shadow:0 10px 40px rgba(0,0,0,0.6); border:4px solid rgba(255,255,255,0.04);
  background:#071a0f; z-index:1;
}
.stage{ position:relative; }
.overlay{
  position:absolute; top:0; left:0; display:flex; align-items:center; justify-content:center;
  flex-direction:column; gap:12px; width:100%; height:100%; pointer-events:auto;
  background:rgba(0,0,0,0.45); border-radius:8px; text-align:center; padding:18px; z-index:3;
}
.overlay.clickable{ cursor:pointer; }
.hidden{ display:none; }
button{
  padding:10px 18px; border:none; border-radius:8px;
  background:#16a34a; color:white; font-weight:700; cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,0.45);
}
button.secondary{ background:#0ea5a6; }
#restart-hint{ font-size:12px; opacity:0.85; margin-top:6px; }
</style>
</head>
<body>
<div id="container">
  <div id="hud">
    <div>Pontos: <span id="score">0</span></div>
    <div>Vidas: <span id="lives">3</span></div>
    <div>Recorde: <span id="highscore">0</span></div>
  </div>

  <div class="stage">
    <canvas id="game" width="800" height="600"></canvas>
    <div id="start-screen" class="overlay">
      <h1>Jogo da Cobrinha</h1>
      <p>Use as setas ou WASD para mover.</p>
      <button id="startBtn">Start</button>
    </div>
    <div id="msg" class="overlay hidden"></div>
  </div>
</div>

<script>
// --- ELEMENTOS DOM ---
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const livesEl = document.getElementById('lives');
const highscoreEl = document.getElementById('highscore');
const startScreen = document.getElementById('start-screen');
const startBtn = document.getElementById('startBtn');
const msg = document.getElementById('msg');

// --- CONFIGURAÇÕES ---
const SCALE = 20;
const COLS = canvas.width / SCALE;
const ROWS = canvas.height / SCALE;
const INITIAL_LIVES = 3;
const POINTS_PER_FOOD = 10;
const FPS = 10;

// --- ESTADO ---
let snake = [];
let dir = {x:0,y:0};
let nextDir = {x:0,y:0};
let food = {x:0,y:0};
let score = 0;
let lives = INITIAL_LIVES;
let highscore = 0;
let running = false;
let lastFrameTime = 0;

// --- SONS ---
const bgMusic = new Audio('snak.mp3'); bgMusic.loop=true; bgMusic.volume=0.2;
const eatSound = new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg'); eatSound.volume=1.0;
const winSound = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'); winSound.volume=1.0;
const gameOverSound = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg'); gameOverSound.volume=1.0;

// --- FUNÇÕES AUXILIARES ---
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function resetSnake(){
  snake=[];
  const startX=Math.floor(COLS/2);
  const startY=Math.floor(ROWS/2);
  for(let i=0;i<4;i++) snake.push({x:startX-i,y:startY});
  dir={x:1,y:0};
  nextDir={x:1,y:0};
}
function spawnFood(){
  do{
    food.x = randInt(0,COLS-1);
    food.y = randInt(0,ROWS-1);
  }while(snake.some(s=>s.x===food.x && s.y===food.y));
}

// --- CHÃO XADREZ SUAVE ---
function drawChessboard(){
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      ctx.fillStyle=(x+y)%2===0?'#f9f2e7':'#eee1c6';
      ctx.fillRect(x*SCALE,y*SCALE,SCALE,SCALE);
    }
  }
}

// --- ANIMAÇÕES ---
let blink=true;
let mouthOpen=true;
let scaleAnim=0;
setInterval(()=>{
  blink=!blink;
  mouthOpen=!mouthOpen;
  scaleAnim=(scaleAnim+1)%2;
},500);

// --- DESENHAR ---
function draw(){
  drawChessboard();
  // --- Desenhar maçã ---
  const fx = food.x*SCALE + SCALE/2;
  const fy = food.y*SCALE + SCALE/2;
  ctx.fillStyle='#ff4c4c';
  ctx.beginPath();
  ctx.arc(fx,fy,SCALE*0.4,0,Math.PI*2);
  ctx.fill();
  ctx.strokeStyle='#2b5d34';
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(fx, fy-SCALE*0.4);
  ctx.lineTo(fx, fy-SCALE*0.6);
  ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.beginPath();
  ctx.arc(fx-SCALE*0.15,fy-SCALE*0.15,SCALE*0.1,0,Math.PI*2);
  ctx.fill();

  // --- Desenhar cobra ---
  snake.forEach((part,i)=>{
    if(i===0){
      // Cabeça com olhos e boca animados
      ctx.fillStyle='#9fffa3';
      ctx.fillRect(part.x*SCALE,part.y*SCALE,SCALE,SCALE);
      ctx.fillStyle='#000';
      if(blink){
        ctx.fillRect(part.x*SCALE+4, part.y*SCALE+4,3,3);
        ctx.fillRect(part.x*SCALE+SCALE-7, part.y*SCALE+4,3,3);
      }
      ctx.fillRect(part.x*SCALE+6, part.y*SCALE+SCALE-(mouthOpen?7:6),4,1);
      ctx.fillStyle='rgba(0,0,0,0.1)';
      ctx.fillRect(part.x*SCALE, part.y*SCALE+SCALE-2,SCALE,2);
    } else {
      // Corpo com escamas animadas
      ctx.fillStyle='#28a745';
      ctx.fillRect(part.x*SCALE,part.y*SCALE,SCALE,SCALE);
      ctx.strokeStyle='#1c7c32';
      ctx.beginPath();
      if(scaleAnim===0){
        ctx.moveTo(part.x*SCALE, part.y*SCALE);
        ctx.lineTo(part.x*SCALE+SCALE, part.y*SCALE+SCALE);
      } else {
        ctx.moveTo(part.x*SCALE+SCALE, part.y*SCALE);
        ctx.lineTo(part.x*SCALE, part.y*SCALE+SCALE);
      }
      ctx.stroke();
    }
  });
}

// --- LÓGICA ---
function update(){
  dir = nextDir;
  const newHead={x:snake[0].x+dir.x, y:snake[0].y+dir.y};
  if(newHead.x<0||newHead.x>=COLS||newHead.y<0||newHead.y>=ROWS||snake.some(s=>s.x===newHead.x&&s.y===newHead.y)){
    handleDeath(); return;
  }
  snake.unshift(newHead);
  if(newHead.x===food.x && newHead.y===food.y){
    score+=POINTS_PER_FOOD;
    scoreEl.textContent=score;
    try{ eatSound.currentTime=0; eatSound.play(); }catch(e){}
    spawnFood();
  } else { snake.pop(); }
}

// --- GAME OVER / VIDA ---
function handleDeath(){
  running=false; // pausa loop
  if(lives>0) lives--;
  livesEl.textContent=lives;
  if(lives>0){
    showTempMessage(`Você perdeu uma vida! Vidas: ${lives}`,900,()=>{
      resetSnake(); spawnFood(); running=true; requestAnimationFrame(gameLoop);
    });
  } else {
    try{ bgMusic.pause(); }catch(e){}
    try{ gameOverSound.play(); }catch(e){}
    if(score>highscore){ highscore=score; highscoreEl.textContent=highscore; }
    showMessage(`Game Over! Pontos: ${score}`,false);
  }
}

// --- OVERLAYS ---
function showTempMessage(text,duration=900,cb){
  msg.textContent=text; msg.classList.remove('hidden');
  setTimeout(()=>{ msg.classList.add('hidden'); if(cb)cb(); },duration);
}
function showMessage(text,isWin=false){
  msg.innerHTML=`<div><strong>${isWin?'Vitória':'Game Over'}</strong><br>${text}<br><small id="restart-hint">Clica na tela para recomeçar</small></div>`;
  msg.classList.add('clickable'); msg.classList.remove('hidden');
  msg.addEventListener('click',()=>{ restartMatch(); },{once:true});
}

// --- LOOP PRINCIPAL ---
function gameLoop(timestamp){
  if(!running) return;
  requestAnimationFrame(gameLoop);
  if(timestamp-lastFrameTime>1000/FPS){
    update(); draw();
    lastFrameTime=timestamp;
  }
}

// --- START / RESTART ---
function startGame(){
  startScreen.classList.add('hidden');
  score=0; lives=INITIAL_LIVES;
  scoreEl.textContent=score; livesEl.textContent=lives;
  resetSnake(); spawnFood();
  try{ bgMusic.currentTime=0; bgMusic.play(); }catch(e){}
  running=true;
  requestAnimationFrame(gameLoop);
}
function restartMatch(){
  score=0; scoreEl.textContent=score;
  lives=INITIAL_LIVES; livesEl.textContent=lives;
  resetSnake(); spawnFood();
  try{ bgMusic.currentTime=0; bgMusic.play(); }catch(e){}
  msg.classList.add('hidden'); msg.classList.remove('clickable');
  running=true;
  requestAnimationFrame(gameLoop);
}

// --- EVENTOS ---
startBtn.addEventListener('click',startGame);
window.addEventListener('keydown',e=>{
  switch(e.key){
    case 'ArrowUp': case 'w': case 'W': if(dir.y!==1) nextDir={x:0,y:-1}; break;
    case 'ArrowDown': case 's': case 'S': if(dir.y!==-1) nextDir={x:0,y:1}; break;
    case 'ArrowLeft': case 'a': case 'A': if(dir.x!==1) nextDir={x:-1,y:0}; break;
    case 'ArrowRight': case 'd': case 'D': if(dir.x!==-1) nextDir={x:1,y:0}; break;
  }
});

// --- INICIALIZAÇÃO ---
resetSnake(); spawnFood(); draw();
</script>
</body>
</html>
